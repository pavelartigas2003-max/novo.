<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ù–û–í–û-–û–ë–¨–Ø–í–õ–ï–ù–ò–Ø</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;
  background: #f2f2f7;
}
h3 {
  margin-bottom: 10px;
}
.search {
  padding: 12px;
  width: 100%;
  margin-bottom: 15px;
  border-radius: 12px;
  border: 1px solid #ddd;
}
.categories {
  display: flex;
  overflow-x: auto;
  margin-bottom: 15px;
}
.cat {
  padding: 8px 16px;
  background: #fff;
  border-radius: 20px;
  margin-right: 10px;
  flex-shrink: 0;
  cursor: pointer;
  transition: transform 0.2s;
}
.cat:hover { transform: scale(1.05); }

.list { display: flex; flex-direction: column; gap: 15px; }

.item {
  background: #fff;
  border-radius: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  overflow: hidden;
  cursor: grab;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
  touch-action: pan-y;
  position: relative;
}
.item.dragging {
  transition: none;
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}
.item img {
  width: 100%;
  height: 180px;
  object-fit: cover;
}
.item-content {
  padding: 12px;
}
.item-title { font-weight: bold; font-size: 16px; margin-bottom: 6px; }
.item-price { color: #FF6B00; font-size: 15px; margin-bottom: 10px; }
.item-actions { display: flex; gap: 10px; }
.item-actions button {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 10px;
  color: #fff;
  font-weight: bold;
  cursor: pointer;
  transition: opacity 0.2s;
}
.item-actions button:hover { opacity: 0.9; }
.call-btn { background: #28a745; }
.msg-btn { background: #007bff; }

/* –°–≤–∞–π–ø-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã */
.swipe-indicator {
  position: absolute;
  top: 20px;
  font-size: 40px;
  font-weight: bold;
  opacity: 0.3;
  pointer-events: none;
}
.swipe-right { left: 20px; color: #28a745; }
.swipe-left { right: 20px; color: #dc3545; }

</style>
</head>
<body>

<h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
<div class="categories" id="cats"></div>

<input class="search" id="q" placeholder="–ü–æ–∏—Å–∫...">

<div class="list" id="list"></div>

<h3>–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h3>
<input id="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="search">
<input id="price" placeholder="–¶–µ–Ω–∞" class="search">
<textarea id="desc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" class="search"></textarea>
<input type="file" id="img">

<button onclick="add()">üí¨ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>

<script>
const tg = Telegram.WebApp;
tg.expand();
const api = "http://localhost:3000/api"; // –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π –±–µ–∫–µ–Ω–¥

const categories = ["–¢–µ—Ö–Ω–∏–∫–∞","–û–¥–µ–∂–¥–∞","–£—Å–ª—É–≥–∏","–ê–≤—Ç–æ","–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å","–î—Ä—É–≥–æ–µ"];

document.getElementById("cats").innerHTML = categories
  .map(c => `<div class="cat" onclick="load('${c}')">${c}</div>`).join("");

// –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
async function load(cat="") {
  const q = document.getElementById("q").value;
  const res = await fetch(`${api}/posts?cat=${cat}&q=${q}`);
  const data = await res.json();

  document.getElementById("list").innerHTML = data.map(p => `
    <div class="item">
      <div class="swipe-indicator swipe-left">‚ùå</div>
      <div class="swipe-indicator swipe-right">‚ù§Ô∏è</div>
      <img src="${p.img}" onclick="openPost('${p.id}')">
      <div class="item-content">
        <div class="item-title">${p.title}</div>
        <div class="item-price">${p.price} ‚ÇΩ</div>
        <div class="item-actions">
          <button class="call-btn" onclick="callUser(event, '${p.user}')">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
          <button class="msg-btn" onclick="msgUser(event, '${p.user}')">‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å</button>
        </div>
      </div>
    </div>
  `).join("");

  makeSwipeable();
}

function openPost(id){ window.location.href = `post.html?id=${id}`; }
function callUser(e, userId){ e.stopPropagation(); alert('–ü–æ–∑–≤–æ–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: ' + userId); }
function msgUser(e, userId){ e.stopPropagation(); alert('–ù–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: ' + userId); }

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
async function add(){
  const fd = new FormData();
  fd.append("title", title.value);
  fd.append("price", price.value);
  fd.append("desc", desc.value);
  fd.append("cat", "–î—Ä—É–≥–æ–µ");
  fd.append("user", tg.initDataUnsafe.user.id);
  fd.append("img", document.getElementById("img").files[0]);

  await fetch(api+"/posts", {method:"POST", body:fd});
  load();
}

// –ü–æ–∏—Å–∫ –ø–æ –≤–≤–æ–¥—É
document.getElementById("q").oninput = () => load();

// –°–≤–∞–π–ø—ã –∫–∞—Ä—Ç–æ—á–µ–∫
function makeSwipeable() {
  const items = document.querySelectorAll('.item');
  items.forEach(item => {
    let startX = 0, currentX = 0, isDragging = false;

    const rightIndicator = item.querySelector('.swipe-right');
    const leftIndicator = item.querySelector('.swipe-left');

    item.addEventListener('touchstart', e => {
      startX = e.touches[0].clientX;
      isDragging = true;
      item.classList.add('dragging');
    });

    item.addEventListener('touchmove', e => {
      if(!isDragging) return;
      currentX = e.touches[0].clientX - startX;
      item.style.transform = `translateX(${currentX}px) rotate(${currentX*0.05}deg)`;

      // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã —Å–≤–∞–π–ø–∞
      if(currentX > 0) {
        rightIndicator.style.opacity = Math.min(currentX/100,1);
        leftIndicator.style.opacity = 0;
      } else {
        leftIndicator.style.opacity = Math.min(-currentX/100,1);
        rightIndicator.style.opacity = 0;
      }
    });

    item.addEventListener('touchend', () => {
      isDragging = false;
      item.classList.remove('dragging');

      if(currentX > 100) {
        item.style.transition = 'transform 0.3s ease';
        item.style.transform = 'translateX(1000px) rotate(15deg)';
        setTimeout(() => item.remove(), 300);
        console.log('–õ–∞–π–∫ –∫–∞—Ä—Ç–æ—á–∫–∏!');
      } else if(currentX < -100) {
        item.style.transition = 'transform 0.3s ease';
        item.style.transform = 'translateX(-1000px) rotate(-15deg)';
        setTimeout(() => item.remove(), 300);
        console.log('–ü—Ä–æ–ø—É—â–µ–Ω–æ!');
      } else {
        item.style.transition = 'transform 0.3s ease';
        item.style.transform = 'translateX(0)';
      }

      rightIndicator.style.opacity = 0;
      leftIndicator.style.opacity = 0;
      currentX = 0;
    });
  });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
load();
</script>
</body>
</html>

